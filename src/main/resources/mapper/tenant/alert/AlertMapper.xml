<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.multi.y2k4.mapper.tenant.alert.AlertMapper">
    <select id="selectAlerts" resultType="com.multi.y2k4.vo.alert.Alert" parameterType="Long">
        SELECT a.*, d.title AS doc_title, d.status AS doc_status, req.emp_name AS req_name, appr.emp_name AS appr_name
        FROM `db_104-81-53114`.alerts a
                 JOIN `db_104-81-53114`.documents d ON d.doc_id = a.doc_id
                 LEFT JOIN `db_104-81-53114`.human_resource req ON req.emp_id = d.req_id
                 LEFT JOIN `db_104-81-53114`.human_resource appr on appr.emp_id = d.appr_id
        WHERE a.emp_id = #{emp_id}
          AND a.is_read = 0
        ORDER BY a.created_at DESC
    </select>

    <update id="updateIsRead" parameterType="int">
        UPDATE `db_104-81-53114`.alerts
        SET is_read = 1
        WHERE alert_id = #{alertId}
    </update>

    <delete id="deleteAlert" parameterType="int">
        DELETE FROM `db_104-81-53114`.alerts
        WHERE is_read = 1
          AND emp_id = #{empId}
    </delete>

    <insert id="insertAlert" parameterType="com.multi.y2k4.vo.alert.Alert">
        INSERT INTO `db_104-81-53114`.alerts (emp_id, doc_id, alert_type, is_read)
        VALUES (#{emp_id}, #{doc_id}, #{alert_type}, #{is_read})
    </insert>

    <!-- 결재자 전용 알림 쿼리 -->
    <insert id="insertAlertForApprover" parameterType="map">
        INSERT INTO `db_104-81-53114`.alerts (emp_id, doc_id, alert_type, is_read)
        SELECT hr.supervisor AS emp_id,
               #{doc_id}      AS doc_id,
               #{alert_type}  AS alert_type,
               0              AS is_read
        FROM `db_104-81-53114`.documents d
                 JOIN `db_104-81-53114`.human_resource hr
                      ON hr.emp_id = d.req_id
        WHERE d.doc_id = #{doc_id}
    </insert>
</mapper>
