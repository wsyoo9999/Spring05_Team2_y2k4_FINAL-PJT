<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.multi.y2k4.mapper.tenant.production.ProductionMapper">

    <resultMap id="WorkOrderMap" type="com.multi.y2k4.vo.production.WorkOrder">
        <id property="work_order_id" column="work_order_id"/>
        <result property="stock_id" column="stock_id"/>
        <result property="stock_name" column="stock_name"/>
        <result property="emp_id" column="emp_id"/>
        <result property="emp_name" column="emp_name"/>
        <result property="start_date" column="start_date"/>
        <result property="due_date" column="due_date"/>
        <result property="target_qty" column="target_qty"/>
        <result property="good_qty" column="good_qty"/>
        <result property="defect_qty" column="defect_qty"/>
        <result property="order_status" column="order_status"/>
        <result property="request_date" column="request_date"/>
    </resultMap>

    <resultMap id="LotMap" type="com.multi.y2k4.vo.production.Lot">
        <id property="lot_id" column="lot_id"/>
        <result property="work_order_id" column="work_order_id"/>
        <result property="stock_id" column="stock_id"/>
        <result property="lot_qty" column="lot_qty"/>
        <result property="lot_date" column="lot_date"/>
    </resultMap>

    <resultMap id="DefectMap" type="com.multi.y2k4.vo.production.Defect">
        <id property="defect_code" column="defect_id"/>
        <result property="lot_id" column="lot_id"/>
        <result property="defect_qty" column="defect_qty"/>
        <result property="defect_date" column="defect_date"/>
        <result property="work_order_id" column="work_order_id"/>
        <result property="stock_id" column="stock_id"/>
    </resultMap>

    <resultMap id="BOMMap" type="com.multi.y2k4.vo.production.BOM">
        <id property="bom_id" column="bom_id"/>
        <result property="parent_stock_id" column="parent_stock_id"/>
        <result property="child_stock_id" column="child_stock_id"/>
        <result property="required_qty" column="required_qty"/>
    </resultMap>

    <select id="getWorkOrderList" resultMap="WorkOrderMap">
        SELECT
        w.work_order_id,
        w.stock_id,
        s.stock_name,
        w.emp_id,
        hr.emp_name,
        w.start_date,
        w.due_date,
        w.target_qty,
        w.good_qty,
        w.defect_qty,
        w.request_date,
        CASE
        WHEN w.order_status = 0 THEN '대기'
        WHEN w.order_status = 1 THEN '진행중'
        WHEN w.order_status = 2 THEN '완료'
        ELSE '알 수 없음'
        END AS order_status
        FROM work_order w
        LEFT JOIN stock s ON w.stock_id = s.stock_id
        LEFT JOIN human_resource hr ON w.emp_id = hr.emp_id <where>
        <if test="order_status != null and order_status != ''">
            <choose>
                <when test="order_status == '대기'"> AND w.order_status = 0 </when>
                <when test="order_status == '진행중'"> AND w.order_status = 1 </when>
                <when test="order_status == '완료'"> AND w.order_status = 2 </when>
            </choose>
        </if>
        <if test="stock_name != null and stock_name != ''">
            AND s.stock_name LIKE CONCAT('%', #{stock_name}, '%')
        </if>
        <if test="start_date != null and start_date != ''">
            AND w.start_date >= #{start_date}
        </if>
        <if test="due_date != null and due_date != ''">
            AND w.due_date &lt;= #{due_date}
        </if>
    </where>
    </select>

    <select id="getWorkOrderDetail" resultMap="WorkOrderMap">
        SELECT
            w.work_order_id,
            w.stock_id,
            s.stock_name,
            w.emp_id,
            hr.emp_name, w.start_date,
            w.due_date,
            w.target_qty,
            w.good_qty,
            w.defect_qty,
            w.request_date,
            CASE
                WHEN w.order_status = 0 THEN '대기'
                WHEN w.order_status = 1 THEN '진행중'
                WHEN w.order_status = 2 THEN '완료'
                ELSE '알 수 없음'
                END AS order_status
        FROM work_order w
                 LEFT JOIN stock s ON w.stock_id = s.stock_id
                 LEFT JOIN human_resource hr ON w.emp_id = hr.emp_id WHERE w.work_order_id = #{work_order_id}
    </select>

    <select id="getWorkOrderDefects" resultMap="DefectMap">
        SELECT d.defect_id, d.lot_id, d.defect_qty, d.defect_date,
               l.work_order_id, l.stock_id
        FROM defect d
                 JOIN lot l ON d.lot_id = l.lot_id
        WHERE l.work_order_id = #{work_order_id}
    </select>

    <select id="getBOMList" resultMap="BOMMap">
        SELECT bom_id, parent_stock_id, child_stock_id, required_qty
        FROM bom
        <where>
            <if test="parent_stock_id != null">
                AND parent_stock_id = #{parent_stock_id}
            </if>
            <if test="child_stock_id != null">
                AND child_stock_id = #{child_stock_id}
            </if>
        </where>
    </select>

    <insert id="addWorkOrder" parameterType="com.multi.y2k4.vo.production.WorkOrder">
        INSERT INTO work_order (
            stock_id, emp_id, start_date, due_date,
            target_qty, request_date,
            good_qty, defect_qty, order_status
        )
        VALUES (
                   #{stock_id}, #{emp_id}, #{start_date}, #{due_date},
                   #{target_qty}, #{request_date},
                   0, 0, 0
               )
    </insert>

    <insert id="addBOM" parameterType="com.multi.y2k4.vo.production.BOM">
        INSERT INTO bom (parent_stock_id, child_stock_id, required_qty)
        VALUES (#{parent_stock_id}, #{child_stock_id}, #{required_qty})
    </insert>
    <delete id="deleteWorkOrder">
        DELETE FROM work_order
        WHERE work_order_id = #{work_order_id}
    </delete>
    <select id="getBOMById" resultMap="BOMMap">
        SELECT bom_id, parent_stock_id, child_stock_id, required_qty
        FROM bom
        WHERE bom_id = #{bom_id}
    </select>

    <update id="updateBOM" parameterType="com.multi.y2k4.vo.production.BOM">
        UPDATE bom
        SET required_qty = #{required_qty}
        WHERE bom_id = #{bom_id}
    </update>

    <delete id="deleteBOM">
        DELETE FROM bom
        WHERE bom_id = #{bom_id}
    </delete>

    <insert id="addLot" parameterType="com.multi.y2k4.vo.production.Lot"
            useGeneratedKeys="true" keyProperty="lot_id">
        INSERT INTO lot (work_order_id, stock_id, lot_qty, lot_date)
        VALUES (#{work_order_id}, #{stock_id}, #{lot_qty}, #{lot_date})
    </insert>

</mapper>