<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <title>판매 목록 추가</title>
    <style>
        :root{
            --primary-color:#4A90E2;
            --bg-light:#F8F9FA;
            --text-dark:#333333;
            --border-color:#E0E0E0;
            --card-bg:#FFFFFF;
        }
        /* 배경/폰트 기본 */
        html,body{
            height:100%;
        }
        body{
            margin:0;
            font-family:'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            background:var(--bg-light);
            color:var(--text-dark);
            display:flex;
            align-items:flex-start;
            justify-content:center;
            padding:24px;
            box-sizing:border-box;
        }

        /* 폼 카드 느낌 (폼 태그 자체를 카드로) */
        form#form{
            width:min(680px, 100%);
            background:var(--card-bg);
            border-radius:12px;
            box-shadow:0 8px 20px rgba(0,0,0,.06);
            padding:22px 24px;
            border:1px solid var(--border-color);
        }

        /* 제목 효과 없이 상단 라벨 정리 */
        form#form > label{
            display:inline-block;
            width:calc(50% - 10px);
            vertical-align:top;
            margin:0 10px 14px 0;
        }
        /* 줄바꿈 <br> 간격 최소화 */
        form#form br{ line-height:0; }

        /* 공통 라벨/인풋 */
        label{
            font-size:14px;
            color:#555;
            font-weight:600;
        }
        label > input[type="text"],
        label > input[type="date"],
        label > input[type="number"]{
            display:block;
            width:100%;
            margin-top:6px;
            padding:10px 12px;
            font-size:15px;
            color:var(--text-dark);
            border:1px solid var(--border-color);
            border-radius:6px;
            outline:none;
            box-sizing:border-box;
            transition:border-color .15s, box-shadow .15s;
            background:#fff;
        }
        input:focus{
            border-color:var(--primary-color);
            box-shadow:0 0 0 3px rgba(74,144,226,.15);
        }

        /* 상세 항목 영역을 그리드처럼 */
        .detail{
            margin-top:8px;
            padding:14px 12px;
            background:#fbfcff;
            border:1px dashed #dbe6ff;
            border-radius:8px;
        }
        .detail > label{
            display:inline-block;
            width:calc(50% - 10px);
            margin:0 10px 12px 0;
        }
        .detail > div{ /* 동적 추가되는 div */
            margin-top:8px;
        }
        .detail > div > label{
            display:inline-block;
            width:calc(50% - 10px);
            margin:0 10px 12px 0;
        }

        select{
            width:100%;
            height:36px;
            padding:6px 10px;
            font-size:14px;
            color:var(--text-dark);
            border:1px solid var(--border-color);
            border-radius:4px;
            outline:none;
            background:#fff;
        }

        /* 버튼들 */
        input[type="submit"]{
            width:100%;
            margin-top:10px;
            padding:12px 18px;
            border:none;
            border-radius:8px;
            background:var(--primary-color);
            color:#fff;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            transition:filter .15s, transform .03s;
        }
        input[type="submit"]:hover{ filter:brightness(0.95); }
        input[type="submit"]:active{ transform:translateY(1px); }

        .createForm{
            display:block;
            width:min(680px, 100%);
            margin:12px auto 0;
            padding:10px 14px;
            border-radius:8px;
            border:1px solid #cfe0ff;
            background:#e9f1ff;
            color:#1f4d8a;
            font-weight:600;
            cursor:pointer;
            transition:background .15s, border-color .15s;
        }
        .createForm:hover{
            background:#dfeaff;
            border-color:#bcd2ff;
        }

        /* 반응형 최적화 */
        @media (max-width:640px){
            form#form > label,
            .detail > label,
            .detail > div > label{
                width:100%;
                margin-right:0;
            }
            .createForm{ width:100%; }
        }

        /* 작은 섹션 라인 (주문일/납기일 라인 구분 감성) */
        form#form > label:nth-of-type(3),
        form#form > label:nth-of-type(4){
            position:relative;
        }
        form#form > label:nth-of-type(4)::after{
            content:"";
            position:absolute; left:0; right:0; bottom:-8px;
            height:1px; background:#eef2f6;
        }
    </style>
</head>
<body>
<form method="POST" action="/api/transaction/sale/add" id="form">
    <label>담당자
        <select id="emp_id" name="emp_id" required>
            <option value="">로딩 중</option>
        </select>
    </label>
    <label>거래처
        <select id="ac_id" name="ac_id" required>
            <option value="">로딩 중</option>
        </select>
    </label><br>
    <label>주문 수주일
        <input type="date" name="order_date" required>
    </label>
    <label>납기일
        <input type="date" name="due_date" required>
    </label><br>

    <div class = "detail">
        <div class="stock_detail">
            <label>제품명
                <select id="stock_id" name="stock_id[]" class = "stock-select" required>
                    <option value="">로딩 중</option>
                </select>
            </label>
            <label>가격
                <input type="number" class="price_display" placeholder="물품 가격" disabled>
                <input type="hidden" name="price_per_unit[]" class="price_per_unit_hidden">
            </label></div>
        <label>수량
            <input type="number" name="qty[]" min="1" required>
        </label>
        <br>
    </div>

    <input type="submit" value="입력 완료">
    <input type="button" class ="createForm" value="추가 입력">

</form>


</body>

<script>



    const create = document.querySelector(".createForm");
    const detail = document.querySelector(".detail");


    let emp_option= '<option value="">선택</option>';   //select의 옵션에 들어갈 값들
    let ac_option= '<option value="">선택</option>';
    let stock_option= '<option value="">선택</option>';

    let optionLoaded = false;

    async function loadSelectForm(){
        try {
            const [emp, ac, stock] = await Promise.all([
                    $.ajax({    //담당자
                        url: `/api/hr/employees`, // 새로운 API 엔드포인트 호출
                        method: 'GET',
                        dataType: 'json'
                    }),

                    $.ajax({    //거래처
                        url: `/api/account/list`, // 새로운 API 엔드포인트 호출
                        method: 'GET',
                        dataType: 'json'
                    }),
                    $.ajax({    //물품 ID
                        url: `/api/inventory/stock`, // 새로운 API 엔드포인트 호출
                        method: 'GET',
                        dataType: 'json'
                    })

                ]
            )

            $.each(emp, function (i, row) {
                emp_option += `<option value="${row.emp_id}">${row.emp_name}</option>`;
            })
            $.each(ac, function (i, row) {
                ac_option += `<option value="${row.ac_id}">${row.ac_name}</option>`;
            })
            $.each(stock, function (i, row) {
                stock_option += `<option value="${row.stock_id}" data-price="${row.unit_price}">${row.stock_name}</option>`;
            })

            $('#emp_id').html(emp_option);
            $('#ac_id').html(ac_option);
            $('#stock_id').html(stock_option);
            optionLoaded = true;
        }catch(err){
            alert('옵션 데이터를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
            // 실패 시 최소한의 표시
            $('#emp_id').html('<option value="">불러오기 실패</option>');
            $('#ac_id').html('<option value="">불러오기 실패</option>');
            $('.stock-select').html('<option value="">불러오기 실패</option>');
        }
    }

    $(async function(){
        await loadSelectForm();

        create.addEventListener("click", (e) => {
            if(!optionLoaded){
                alert('옵션을 불러오는 중입니다. 잠시만 기다려주세요.');
                return;
            }
            const addDataForm = document.createElement('div');
            addDataForm.innerHTML = ` <hr><label>제품명
                                    <div class = "stock_detail">
                                    <select  name="stock_id[]" class="stock-select" required>
                                    `+stock_option+
                `</select>
                                    </label>
                                    <label>가격
                                    <input type="number" class="price_display" placeholder="물품 가격" disabled>
                                    <input type="hidden" name="price_per_unit[]" class="price_per_unit_hidden">
                                  </label></div>
                                  <label>수량
                                        <input type="number" name="qty[]" min="1" required>
                                    </label><br>`;
            detail.appendChild(addDataForm);
        })

        const form = document.getElementById("form");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!$('#emp_id').val() || !$('#ac_id').val() || $('.stock-select').toArray().some(sel => !sel.value)) {
                alert('담당자/거래처/제품을 선택하세요.');
                return;
            }

            const result = await $.ajax({
                url: form.action,
                method: 'POST',
                dataType: 'json',
                data: $(form).serialize()


            });
            if (result === true) {
                alert('입력 성공');
                // 부모 창에 갱신 신호 (선택)
                window.close(); // 알림 확인 후 닫힘
            } else {
                alert('입력 실패');
            }
        })
        $('.detail').on('change', '.stock-select', async function () {
            const change_row =  $(this).closest('.stock_detail');
            const display_price = change_row.find('.price_display');
            const hidden = change_row.find('input[name="price_per_unit[]"]');
            const stockId = $(this).val();
            if (!stockId) {
                display_price.val('');
                hidden.val('');
                return;
            }
            let price = $(this).find('option:selected').data('price');
            if (price == null || price === '') {
                price = 0.0;
            }
            console.log("price : "+price);
            display_price.val(price);
            hidden.val(price);


        })


    })
</script>
</html>
