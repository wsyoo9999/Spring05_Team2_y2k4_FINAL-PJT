<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <title>ê·¼íƒœ ê¸°ë¡ ìˆ˜ì •</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f8f8; }
        .detail-card {
            background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px; max-width: 450px; margin: auto;
        }
        h2 { border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-bottom: 20px; color: #ffc107;}
        .info-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 20px; }
        .info-label { font-weight: bold; color: #555; }
        .info-value { border-bottom: 1px dashed #ddd; padding-bottom: 5px; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        #updateForm label { display: block; margin-top: 10px; font-weight: bold; }
        #updateForm select,
        #updateForm input[type="time"] {
            width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        #updateForm button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="detail-card">
    <h2>ğŸ—“ï¸ ê·¼íƒœ ê¸°ë¡ ìˆ˜ì •</h2>

    <div id="loading" style="text-align: center;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>

    <div id="attendance-detail-content" style="display: none;">
        <div class="info-grid">
            <div class="info-label">ì‚¬ë²ˆ</div><div class="info-value" id="empIdValue"></div>
            <div class="info-label">ì´ë¦„</div><div class="info-value" id="empNameValue"></div>
            <div class="info-label">ê·¼ë¬´ ì¼ì</div><div class="info-value" id="workDateValue"></div>
        </div>

        <h3>ê·¼ë¬´ ìƒíƒœ ë³€ê²½</h3>
        <form id="updateForm">
            <label for="check_in_time">ì¶œê·¼ ì‹œê°„:</label>
            <input type="time" id="check_in_time" name="check_in_time" required>

            <label for="check_out_time">í‡´ê·¼ ì‹œê°„:</label>
            <input type="time" id="check_out_time" name="check_out_time" required>

            <label for="status">ê·¼ë¬´ ìƒíƒœ:</label>
            <select id="status" name="attendance_status" required>
                <option value="ì •ìƒ">ì •ìƒ</option>
                <option value="ì§€ê°">ì§€ê°</option>
                <option value="ì¡°í‡´">ì¡°í‡´</option>
                <option value="ê²°ê·¼">ê²°ê·¼</option>
            </select>

            <button type="submit">ìƒíƒœ ìˆ˜ì • ì™„ë£Œ</button>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = '/api/hr/attendance';
    let currentAttendanceId = null;
    let currentWorkDate = null;

    // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ID ê°€ì ¸ì˜¤ê¸°
    function getAttendanceIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('attendanceId');
    }

    // ì‹œê°„ í¬ë§· (HH:MM)
    function formatTime(dateTimeString) {
        if (!dateTimeString) return '00:00'; // [ìˆ˜ì •] ê¸°ë³¸ê°’
        const time = dateTimeString.split('T')[1];
        if (time) return time.substring(0, 5); // "HH:MM"

        // "YYYY-MM-DD HH:MM:SS" ê°™ì€ êµ¬í˜• í¬ë§· ëŒ€ë¹„
        const parts = dateTimeString.split(' ');
        if (parts.length > 1) {
            return parts[1].substring(0, 5);
        }
        return '00:00';
    }

    // 1. ìƒì„¸ ë°ì´í„° ë¡œë“œ
    async function loadAttendanceDetail() {
        const attendanceId = getAttendanceIdFromUrl();
        currentAttendanceId = attendanceId;

        if (!attendanceId) {
            document.getElementById('loading').innerHTML = '<p style="color: red;"> ì˜¤ë¥˜: ê·¼íƒœ IDê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        try {
            const data = await $.ajax({
                url: `${API_BASE_URL}/${attendanceId}`,
                method: 'GET',
                dataType: 'json'
            });

            if (data && data.attendance_id) {
                // â–¼ [ìˆ˜ì •] ì‹œê°„ ë° ë‚ ì§œ ì²˜ë¦¬
                currentWorkDate = data.work_date; // ë‚ ì§œ ì €ì¥ (ì˜ˆ: "2025-11-17")
                const checkIn = formatTime(data.check_in);
                const checkOut = formatTime(data.check_out);

                // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                document.getElementById('empIdValue').textContent = data.emp_id;
                document.getElementById('empNameValue').textContent = data.emp_name;
                document.getElementById('workDateValue').textContent = data.work_date;
                // document.getElementById('timeValue').textContent = `${checkIn} ~ ${checkOut}`; // [ì‚­ì œ]

                // í¼ ì´ˆê¸°ê°’ ì„¤ì • (í˜„ì¬ ìƒíƒœ)
                document.getElementById('check_in_time').value = checkIn;
                document.getElementById('check_out_time').value = checkOut;
                document.getElementById('status').value = data.attendance_status;


                document.getElementById('loading').style.display = 'none';
                document.getElementById('attendance-detail-content').style.display = 'block';

            } else {
                document.getElementById('loading').innerHTML = `<p class="error-message">ID ${attendanceId}ì— ëŒ€í•œ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

        } catch (err) {
            console.error("ê·¼íƒœ ìƒì„¸ ë¡œë”© ì‹¤íŒ¨:", err);
            document.getElementById('loading').innerHTML = '<p style="color: red;">ğŸš¨ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // 2. í¼ ì œì¶œ (ìˆ˜ì •) ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById('updateForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // â–¼ [ìˆ˜ì •] ì‹œê°„ ê°’ì„ ê°€ì ¸ì™€ì„œ YYYY-MM-DDTHH:MM í˜•ì‹ìœ¼ë¡œ ì¡°í•©
        const status = document.getElementById('status').value;
        const checkInTime = document.getElementById('check_in_time').value; // "HH:MM"
        const checkOutTime = document.getElementById('check_out_time').value; // "HH:MM"

        if (!currentWorkDate) {
            alert('ì˜¤ë¥˜: ê·¼ë¬´ ì¼ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì„œë²„ì˜ LocalDateTime í˜•ì‹(YYYY-MM-DDTHH:MM)ìœ¼ë¡œ ì¡°í•©
        const checkInDateTime = `${currentWorkDate}T${checkInTime}`;
        const checkOutDateTime = `${currentWorkDate}T${checkOutTime}`;
        // â–² [ìˆ˜ì •]

        // PUT ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ìˆ˜ì •ëœ ë°ì´í„° ì „ì†¡
        try {
            const result = await $.ajax({
                url: `${API_BASE_URL}/${currentAttendanceId}`,
                method: 'PUT',
                contentType: 'application/json',

                data: JSON.stringify({
                    attendance_status: status,
                    check_in: checkInDateTime,
                    check_out: checkOutDateTime
                })

            });

            if (result === true) {
                alert('âœ… ê·¼íƒœ ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');

                if (window.opener && !window.opener.closed) {

                    const menu = window.opener.document.querySelector('.menu[data-file="hr"][data-fn="attendance_listAll"]');
                    if (menu) {
                        menu.click();
                    } else {
                        window.opener.location.reload(); // ìµœí›„ì˜ ìˆ˜ë‹¨
                    }
                }
                window.close();
            } else {
                alert('âŒ ìƒíƒœ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

        } catch (error) {
            console.error('ìƒíƒœ ìˆ˜ì • ì‹¤íŒ¨:', error);
            alert('âŒ ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });


    $(document).ready(loadAttendanceDetail);
</script>
</body>
</html>