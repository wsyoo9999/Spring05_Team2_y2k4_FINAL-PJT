<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <title>ê²°ì¬ ë¬¸ì„œ ì •ë³´</title>
  <style>
    /* ê¸°ë³¸ ë¦¬ì…‹ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #4A90E2;
      --secondary-color: #50B86C;
      --bg-light: #F8F9FA;
      --bg-dark: #343A40;
      --text-dark: #333333;
      --text-light: #FFFFFF;
      --border-color: #E0E0E0;
      --card-bg: #FFFFFF;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .detail-card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 720px;
      margin: 0 auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .doc-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .sub-meta {
      font-size: 13px;
      color: #6b7280;
      margin-top: 4px;
    }

    .section-title {
      margin-top: 20px;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 15px;
      color: #374151;
    }

    /* ë¬¸ì„œ ì •ë³´ ê·¸ë¦¬ë“œ (2~3ê°œ ì»¬ëŸ¼ì”© í•œ ì¤„) */
    .info-grid {
      margin-top: 8px;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-row {
      display: grid;
      gap: 8px 16px;
    }

    .info-row.two-cols {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .info-row.three-cols {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .info-item {
      font-size: 13px;
    }

    .info-label {
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .info-value {
      color: #111827;
      font-size: 14px;
    }

    .body-box {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #ffffff;
      padding: 12px 14px;
      font-size: 14px;
      word-break: break-word;
    }

    /* content ë¶€ë¶„ì€ HTML ê·¸ëŒ€ë¡œ ë Œë”ë§ */
    .content-box {
      min-height: 80px;
    }

    /* commentsëŠ” ì¤„ë°”ê¿ˆ ìœ ì§€ (ì½ê¸° ì „ìš©ìš©) */
    .comments-box {
      white-space: pre-wrap;
      min-height: 60px;
    }

    .comments-input {
      width: 100%;
      min-height: 80px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
      box-sizing: border-box;
    }

    .btn-wrap {
      margin: 20px auto 0;
      max-width: 720px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .submit-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: var(--primary-color);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      min-width: 80px;
    }

    .submit-btn:hover {
      filter: brightness(0.95);
    }

    .submit-btn.reject {
      background: #e74c3c;
    }

    .submit-btn.reject:hover {
      filter: brightness(0.95);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<div class="detail-card">
  <div id="doc-detail-content">
    ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...
  </div>
</div>

<div class="btn-wrap">
  <button type="button" id="btn-approve" value="1" class="submit-btn">
    ìŠ¹ì¸
  </button>
  <button type="button" id="btn-reject" value="2" class="submit-btn reject">
    ë°˜ë ¤
  </button>
</div>

<script>
  const DOC_CAT_LABELS = {
    0: 'ì¬ë¬´',
    1: 'íŒë§¤/êµ¬ë§¤',
    2: 'ìƒì‚°/ì œì¡°',
    3: 'ì¬ê³ ',
    4: 'ì¸ì‚¬'
  };

  const DOC_TB_LABELS = {
    0: { // ì¬ë¬´
      0: 'íšŒì‚¬ ìˆ˜ìµ ê´€ë¦¬',
      1: 'íšŒì‚¬ ì§€ì¶œ ê´€ë¦¬'
    },
    1: { // íŒë§¤/êµ¬ë§¤
      0: 'íŒë§¤',
      1: 'êµ¬ë§¤'
    },
    2: { // ìƒì‚°/ì œì¡°
      0: 'ì‘ì—… ì§€ì‹œì„œ'
    },
    3: { // ì¬ê³ 
      0: 'ì¬ê³  ê´€ë ¨'
    },
    4: { // ì¸ì‚¬
      0: 'íœ´ê°€/í‡´ì§ ì²˜ë¦¬'
    }
  };

  const DOC_CD_LABELS = {
    0: 'ìƒì„±',
    1: 'ìˆ˜ì •',
    2: 'ì‚­ì œ'
  };

  function getCatLabel(catRaw) {
    const c = Number(catRaw);
    return DOC_CAT_LABELS[c] ?? String(catRaw ?? '');
  }

  function getTbLabel(catRaw, tbRaw) {
    const c = Number(catRaw);
    const t = Number(tbRaw);
    if (DOC_TB_LABELS[c] && DOC_TB_LABELS[c][t]) {
      return DOC_TB_LABELS[c][t];
    }
    return String(tbRaw ?? '');
  }

  function getCDLabel(cdRaw) {
    const c = Number(cdRaw);
    return DOC_CD_LABELS[c] ?? String(cdRaw ?? '');
  }

  function getStatusInfo(statusRaw) {
    const s = Number(statusRaw);
    switch (s) {
      case 0:
        return { text: 'ì²˜ë¦¬ì¤‘', color: '#f39c12' };
      case 1:
        return { text: 'ìŠ¹ì¸', color: '#27ae60' };
      case 2:
        return { text: 'ë°˜ë ¤', color: '#e74c3c' };
      default:
        return { text: String(statusRaw ?? ''), color: '#6b7280' };
    }
  }

  // API í˜¸ì¶œí•˜ì—¬ ìƒì„¸ ë°ì´í„° ë¡œë“œ
  async function loadDocument() {
    const doc_id = new URLSearchParams(location.search).get('doc_id');
    const contentDiv = document.getElementById('doc-detail-content');

    if (!doc_id) {
      contentDiv.innerHTML = '<p style="color: red;">ğŸš¨ ì˜¤ë¥˜: ë¬¸ì„œ ë²ˆí˜¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    try {
      const document = await $.ajax({
        url: '/api/doc/searchById',
        method: 'GET',
        data: { doc_id: doc_id },
        dataType: 'json'
      });

      if (!document) {
        contentDiv.innerHTML = '<p style="color:red;">í•´ë‹¹ ë¬¸ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const title       = document.title ?? '(ì œëª© ì—†ìŒ)';
      const req_date    = document.req_date ?? '';
      const appr_date   = document.appr_date ?? '';
      const cat         = getCatLabel(document.cat_id);
      const tb          = getTbLabel(document.cat_id, document.tb_id);
      const cd          = getCDLabel(document.cd_id);
      const statusObj   = getStatusInfo(document.status);
      const req_name    = document.req_name ?? '';
      const appr_name   = document.appr_name ?? '';
      const contentHtml = document.content ?? '';
      const comments    = document.comments ?? '';

      const statusNum   = Number(document.status);


      let commentsSectionHtml = '';
      if (statusNum === 0) {
        commentsSectionHtml = `
          <div class="section-title">ë¹„ê³ </div>
          <div class="body-box">
            <textarea id="comments-input" class="comments-input"
                      placeholder="ë¹„ê³ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ë°˜ë ¤ ì‚¬ìœ  ë“±)">
${comments || ''}</textarea>
          </div>
        `;
      } else {
        // ì´ë¯¸ ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ëœ ë¬¸ì„œ â†’ ê¸°ì¡´ì²˜ëŸ¼ ì½ê¸° ì „ìš©
        commentsSectionHtml = `
          <div class="section-title">ë¹„ê³ </div>
          <div class="body-box comments-box">
            ${comments || 'ì‘ì„±ëœ ë¹„ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.'}
          </div>
        `;
      }

      contentDiv.innerHTML = `
        <div class="detail-header">
          <div>
            <div class="doc-title">${title}</div>
            <div class="sub-meta">
              ë¬¸ì„œ ë²ˆí˜¸: ${document.doc_id ?? ''} Â· ì¹´í…Œê³ ë¦¬: ${cat} / ${tb} Â· ë¶„ë¥˜: ${cd}
            </div>
          </div>
          <span class="status-badge" style="background-color:${statusObj.color};">
            ${statusObj.text}
          </span>
        </div>

        <div class="section-title">ë¬¸ì„œ ì •ë³´</div>
        <div class="info-grid">
          <!-- 1ì¤„: ê¸°ì•ˆì / ê²°ì¬ì -->
          <div class="info-row two-cols">
            <div class="info-item">
              <div class="info-label">ê¸°ì•ˆì</div>
              <div class="info-value">${req_name} (${document.req_id ?? ''})</div>
            </div>
            <div class="info-item">
              <div class="info-label">ê²°ì¬ì</div>
              <div class="info-value">${appr_name} (${document.appr_id ?? ''})</div>
            </div>
          </div>

          <!-- 2ì¤„: ì‘ì„±ì¼ / ê²°ì¬ì¼ -->
          <div class="info-row two-cols">
            <div class="info-item">
              <div class="info-label">ì‘ì„±ì¼</div>
              <div class="info-value">${req_date}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ê²°ì¬ì¼</div>
              <div class="info-value">${appr_date || '-'}</div>
            </div>
          </div>

          <!-- 3ì¤„: ì¹´í…Œê³ ë¦¬ / ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ / ë¶„ë¥˜ -->
          <div class="info-row three-cols">
            <div class="info-item">
              <div class="info-label">ì¹´í…Œê³ ë¦¬</div>
              <div class="info-value">${cat}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ì„¸ë¶€ ì¹´í…Œê³ ë¦¬</div>
              <div class="info-value">${tb}</div>
            </div>
            <div class="info-item">
              <div class="info-label">ë¶„ë¥˜</div>
              <div class="info-value">${cd}</div>
            </div>
          </div>
        </div>

        <div class="section-title">ë³¸ë¬¸</div>
        <div class="body-box content-box">
          ${contentHtml}
        </div>

        ${commentsSectionHtml}
      `;


      if (statusNum === 1 || statusNum === 2) {
        $('#btn-approve').prop('disabled', true);
        $('#btn-reject').prop('disabled', true);
      }

    } catch (err) {
      console.error("ë¡œë”© ì‹¤íŒ¨:", err);
      contentDiv.innerHTML = '<p style="color: red;">ğŸš¨ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }

  async function changeStatus() {
    const doc_id = new URLSearchParams(location.search).get('doc_id');
    if (!doc_id) {
      alert('doc_idê°€ ì—†ì–´ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    const status = this.value;

    const commentsInput = document.getElementById('comments-input');
    const comments = commentsInput ? commentsInput.value : null;

    try {
      const result = await $.ajax({
        url: '/api/doc/editStatus',
        method: 'POST',
        dataType: 'json',
        data: {
          doc_id: doc_id,
          status: status,
          comments: comments
        }
      });

      if (result === true || result?.success) {
        alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.close?.();
      } else {
        alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', err);
      alert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  $(document).ready(function() {
    loadDocument();
    $('.submit-btn').on('click', changeStatus);
  });
</script>
</body>
</html>


