<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <title>ì§ì› ì •ë³´ ìˆ˜ì •</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f8f8f8; }
        .detail-card {
            background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px; max-width: 550px; margin: auto;
        }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; color: #007bff;}
        .info-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 20px;}
        .info-label { font-weight: bold; color: #555; }
        .info-value { border-bottom: 1px dashed #ddd; padding-bottom: 5px; }

        /* í¼ ìŠ¤íƒ€ì¼ */
        #updateForm label { display: block; margin-top: 10px; font-weight: bold; }
        #updateForm input[type="text"], #updateForm select {
            width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        #updateForm button {
            background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;
        }
        #updateForm button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<div class="detail-card">
    <h2>ğŸ‘¤ ì§ì› ì •ë³´ ìˆ˜ì •</h2>

    <div id="loading" style="text-align: center;">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>

    <div id="employee-detail-content" style="display: none;">
        <div class="info-grid">
            <div class="info-label">ì‚¬ë²ˆ</div><div class="info-value" id="empIdValue"></div>
            <div class="info-label">ì´ë¦„</div><div class="info-value" id="empNameValue"></div>
            <div class="info-label">ì…ì‚¬ì¼</div><div class="info-value" id="hireDateValue"></div>
        </div>

        <h3>ìˆ˜ì • í•­ëª©</h3>
        <form id="updateForm">
            <label for="dept_name">ë¶€ì„œëª…:</label>
            <select id="dept_name" name="dept_name" required>
                <option value="ë¯¸ë°°ì •">ë¯¸ë°°ì •</option>
                <option value="ì¬ë¬´íŒ€">ì¬ë¬´íŒ€</option>
                <option value="ì¸ì‚¬íŒ€">ì¸ì‚¬íŒ€</option>
                <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€</option>
                <option value="íŒë§¤íŒ€">íŒë§¤íŒ€</option>
                <option value="ì¬ê³ íŒ€">ì¬ê³ íŒ€</option>
            </select>

            <label for="position">ì§ê¸‰:</label>
            <select id="position" name="position" required>
                <option value="ë¯¸ì§€ì •">ë¯¸ì§€ì •</option>
                <option value="ì‚¬ì›">ì‚¬ì›</option>
                <option value="ì¤‘ê°„ê´€ë¦¬ì">ì¤‘ê°„ ê´€ë¦¬ì</option>
                <option value="ìµœìƒìœ„ ê´€ë¦¬ì">ìµœìƒìœ„ ê´€ë¦¬ì</option> </select>

            <label for="supervisor">ì§ì† ìƒì‚¬:</label>
            <select id="supervisor" name="supervisor">
                <option value="">ì„ íƒ ì•ˆí•¨</option>
            </select>

            <label for="status">ì¬ì§ ìƒíƒœ:</label>
            <select id="status" name="status" required>
                <option value="ì¬ì§">ì¬ì§</option>
                <option value="íœ´ì§">íœ´ì§</option>
                <option value="í‡´ì‚¬">í‡´ì‚¬</option>
            </select>

            <button type="submit">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
        </form>
    </div>
</div>

<script>
    const API_BASE_URL = '/api/hr/employees';
    let currentEmpId = null;
    let initialStatus = null;

    function getEmpIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('empId');
    }

    /**
     * [ìˆ˜ì •ë¨] ìƒì‚¬ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
     * - ì‚¬ì›: ê°™ì€ ë¶€ì„œì˜ 'ì¤‘ê°„ê´€ë¦¬ì'ë§Œ í‘œì‹œ
     * - ì¤‘ê°„ê´€ë¦¬ì: ë¶€ì„œ ìƒê´€ì—†ì´ 'ìµœìƒìœ„ ê´€ë¦¬ì'ë§Œ í‘œì‹œ
     * - ìµœìƒìœ„ ê´€ë¦¬ì: ìƒì‚¬ ì—†ìŒ (í‘œì‹œ ì•ˆ í•¨)
     */
    async function loadSupervisors(deptName, targetPosition, selectedSupervisorId = null) {
        const $supervisorSelect = $('#supervisor');
        $supervisorSelect.empty();
        $supervisorSelect.append('<option value="">ì„ íƒ ì•ˆí•¨</option>');

        // ì§ê¸‰ì— ë”°ë¥¸ í›„ë³´êµ°ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë¦¬í„´ (ì˜ˆ: ìµœìƒìœ„ ê´€ë¦¬ìëŠ” ìƒì‚¬ ì—†ìŒ)
        if (targetPosition === 'ìµœìƒìœ„ ê´€ë¦¬ì') { // ìˆ˜ì •ë¨
            return;
        }

        try {
            // ì „ì²´ ì§ì› ëª©ë¡ ì¡°íšŒ (ë¶€ì„œ í•„í„°ë§ ì—†ì´ ì „ì²´ ë¡œë“œ í›„ JSì—ì„œ ì²˜ë¦¬)
            const employees = await $.ajax({
                url: '/api/hr/employees',
                method: 'GET',
                dataType: 'json'
            });

            employees.forEach(emp => {
                // 1. ë³¸ì¸ì€ ìƒì‚¬ ëª©ë¡ì—ì„œ ì œì™¸
                const isNotSelf = String(emp.emp_id) !== String(currentEmpId);
                let isCandidate = false;

                // 2. ì§ê¸‰ë³„ ìƒì‚¬ ì¡°ê±´ í™•ì¸
                if (targetPosition === 'ì‚¬ì›' || targetPosition === 'ë¯¸ì§€ì •') {
                    // ì‚¬ì› -> ê°™ì€ ë¶€ì„œì˜ 'ì¤‘ê°„ê´€ë¦¬ì'
                    if (emp.position === 'ì¤‘ê°„ê´€ë¦¬ì' && emp.dept_name === deptName) {
                        isCandidate = true;
                    }
                } else if (targetPosition === 'ì¤‘ê°„ê´€ë¦¬ì') {
                    // ì¤‘ê°„ê´€ë¦¬ì -> ë¶€ì„œ ìƒê´€ì—†ì´ 'ìµœìƒìœ„ ê´€ë¦¬ì'
                    if (emp.position === 'ìµœìƒìœ„ ê´€ë¦¬ì') { // ìˆ˜ì •ë¨
                        isCandidate = true;
                    }
                }

                // 3. ì¡°ê±´ì— ë§ëŠ” ê²½ìš° ëª©ë¡ì— ì¶”ê°€
                if (isNotSelf && isCandidate) {
                    const isSelected = (selectedSupervisorId && String(emp.emp_id) === String(selectedSupervisorId)) ? 'selected' : '';

                    // ì´ë¦„ (ì§ê¸‰ - ë¶€ì„œ) í˜•íƒœë¡œ í‘œì‹œ
                    $supervisorSelect.append(
                        `<option value="${emp.emp_id}" ${isSelected}>${emp.emp_name} (${emp.position} - ${emp.dept_name})</option>`
                    );
                }
            });
        } catch (err) {
            console.error('ìƒì‚¬ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err);
        }
    }

    // 1. ìƒì„¸ ë°ì´í„° ë¡œë“œ
    async function loadEmployeeDetail() {
        const empId = getEmpIdFromUrl();
        currentEmpId = empId;

        if (!empId) {
            document.getElementById('loading').innerHTML = '<p style="color: red;">ğŸš¨ ì˜¤ë¥˜: ì‚¬ë²ˆ(Emp ID)ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        try {
            const data = await $.ajax({
                url: `${API_BASE_URL}/${empId}`,
                method: 'GET',
                dataType: 'json'
            });

            if (data && data.emp_id) {
                document.getElementById('empIdValue').textContent = data.emp_id;
                document.getElementById('empNameValue').textContent = data.emp_name;
                document.getElementById('hireDateValue').textContent = data.hire_date;

                document.getElementById('dept_name').value = data.dept_name;
                document.getElementById('position').value = data.position;
                document.getElementById('status').value = data.status;

                initialStatus = data.status;

                // ì´ˆê¸° ë¡œë“œ ì‹œ ìƒì‚¬ ëª©ë¡ ì±„ìš°ê¸°
                await loadSupervisors(data.dept_name, data.position, data.supervisor);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('employee-detail-content').style.display = 'block';

            } else {
                document.getElementById('loading').innerHTML = `<p class="error-message">ì‚¬ë²ˆ ${empId}ì— ëŒ€í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

        } catch (err) {
            console.error("ì§ì› ìƒì„¸ ë¡œë”© ì‹¤íŒ¨:", err);
            document.getElementById('loading').innerHTML = '<p style="color: red;">ğŸš¨ ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // [ì´ë²¤íŠ¸] ë¶€ì„œ ë³€ê²½ ì‹œ ìƒì‚¬ ëª©ë¡ ê°±ì‹ 
    document.getElementById('dept_name').addEventListener('change', function() {
        const newDept = this.value;
        const currentPos = document.getElementById('position').value;
        loadSupervisors(newDept, currentPos, null);
    });

    // [ì´ë²¤íŠ¸] ì§ê¸‰ ë³€ê²½ ì‹œ ìƒì‚¬ ëª©ë¡ ê°±ì‹ 
    document.getElementById('position').addEventListener('change', function() {
        const currentDept = document.getElementById('dept_name').value;
        const newPos = this.value;
        loadSupervisors(currentDept, newPos, null);
    });

    // 2. í¼ ì œì¶œ (ìˆ˜ì •) ì´ë²¤íŠ¸
    document.getElementById('updateForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const dept_name = document.getElementById('dept_name').value;
        const position = document.getElementById('position').value;
        const status = document.getElementById('status').value;
        const supervisor = document.getElementById('supervisor').value || null;
        const empName = document.getElementById('empNameValue').textContent;

        // [Case 1] ìƒíƒœ ë³€ê²½ (ì¬ì§/íœ´ì§/í‡´ì‚¬) -> ê²°ì¬ ìš”ì²­
        if (status !== initialStatus) {
            if (!confirm(`ì§ì›ì˜ ìƒíƒœë¥¼ '${initialStatus}'ì—ì„œ '${status}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`)) {
                return;
            }
            const reason = prompt("ìƒíƒœ ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:", "ì¸ì‚¬ ë°œë ¹");

            try {
                const result = await $.ajax({
                    url: '/api/hr/employees/request-status-change',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        emp_id: currentEmpId,
                        emp_name: empName,
                        currentStatus: initialStatus,
                        newStatus: status,
                        reason: reason
                    })
                });

                if (result === true) {
                    alert('âœ… ì¸ì‚¬ ë°œë ¹ ê²°ì¬ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nìŠ¹ì¸ ì™„ë£Œ í›„ ë°˜ì˜ë©ë‹ˆë‹¤.');
                    window.close();
                } else {
                    alert('âŒ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨');
                }
            } catch (err) {
                console.error(err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            return;
        }

        // [Case 2] ì¼ë°˜ ì •ë³´(ë¶€ì„œ, ì§ê¸‰, ìƒì‚¬ ë“±) ìˆ˜ì • -> ì¦‰ì‹œ ë°˜ì˜
        try {
            const result = await $.ajax({
                url: `${API_BASE_URL}/${currentEmpId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    dept_name: dept_name,
                    position: position,
                    status: status,
                    supervisor: supervisor // ìƒì‚¬ ì •ë³´ í¬í•¨
                })
            });

            if (result === true) {
                alert('âœ… ì§ì› ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                if (window.opener && !window.opener.closed) {
                    window.opener.location.reload();
                }
                window.close();
            } else {
                alert('âŒ ìˆ˜ì • ì‹¤íŒ¨');
            }

        } catch (error) {
            console.error('ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨:', error);
            alert('âŒ ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });

    $(document).ready(loadEmployeeDetail);
</script>
</body>
</html>