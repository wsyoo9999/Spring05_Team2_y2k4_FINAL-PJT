<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>재고 보기/수정 (viewStock)</title>
</head>
<body>
<h1>재고 보기/수정</h1>

<form id="stockForm">
    <div>
        <label for="stock_id">재고번호</label>
        <input id="stock_id" name="stock_id" type="number" />
    </div>

    <div>
        <label for="stock_name">재고명</label>
        <input id="stock_name" name="stock_name" type="text" />
    </div>

    <div>
        <label for="stock_qty">수량</label>
        <input id="stock_qty" name="stock_qty" type="number" />
    </div>

    <div>
        <label for="unit_price">판매 단가</label>
        <input id="unit_price" name="unit_price" type="number" />
    </div>

    <div>
        <label>물품상태:
            <select name="stock_status">
                <option value="0">정상</option>
                <option value="1">불량</option>
                <option value="2">폐기</option>
                <option value="3">반납</option>
                <option value="4">보류</option>
            </select>
        </label>
    </div>

    <div>
        <label for="storage_location">보관 위치</label>
        <input id="storage_location" name="storage_location" type="text" />
    </div>

    <div>
        <label for="expiration_date">유통기한</label>
        <input id="expiration_date" name="expiration_date" type="date" />
    </div>

    <div>
        <label>구분:
            <select name="gubun">
                <option value="0">원자재</option>
                <option value="1">판매상품</option>
            </select>
        </label>
    </div>

    <div style="margin-top:10px; text-align:right;">
        <button type="submit" id="edit">수정</button>
    </div>
</form>

<!-- jQuery (inventory.js와 동일하게 $.ajax 사용) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    (function () {
        const API_BASE = '/api/inventory/stock';

        // ── 1) URL에서 stock_id 읽기 ──────────────────────────────────────────────
        const params  = new URLSearchParams(location.search);
        const stockId = params.get('stock_id');

        // ── 2) 유틸 ───────────────────────────────────────────────────────────────
        function normalize(data) {
            if (Array.isArray(data)) return data[0] || null;
            if (data && Array.isArray(data.rows)) return data.rows[0] || null;
            return data || null;
        }
        function setById(id, v) {
            const el = document.getElementById(id);
            if (el) el.value = (v ?? '');
        }
        function setSelectByName(name, v) {
            const el = document.querySelector(`select[name="${name}"]`);
            if (el) el.value = String(v ?? '');
        }
        const toInt = v => (v === '' || v == null) ? null : parseInt(v, 10);

        // ── 3) 로드 & 폼 채우기 ───────────────────────────────────────────────────
        async function loadStock(id) {
            const urls = [
                `${API_BASE}/${encodeURIComponent(id)}`,
                `${API_BASE}?stock_id=${encodeURIComponent(id)}`
            ];

            for (const url of urls) {
                try {
                    const data = await $.ajax({ url, method: 'GET', dataType: 'json' });
                    const s = normalize(data);
                    if (s) { fillForm(s); return; }
                } catch (e) { /* 다음 URL 시도 */ }
            }
            alert('데이터를 불러오지 못했습니다.');
        }

        function fillForm(s) {
            // input[id=...]에 채우기
            setById('stock_id',         s.stock_id);
            setById('stock_name',       s.stock_name);
            setById('stock_qty',        s.stock_qty);
            setById('unit_price',       s.unit_price);
            setById('storage_location', s.storage_location);

            // 날짜(문자열). input[type=date]는 "YYYY-MM-DD" 형식이 들어오면 그대로 표시됨
            setById('expiration_date',  s.expiration_date);

            // select[name=...] 채우기 (서버 호환: stock_status 없으면 item_status 사용)
            setSelectByName('stock_status', (s.stock_status ?? s.item_status));
            setSelectByName('gubun', s.gubun);

            // PK는 보통 수정 금지
            const pk = document.getElementById('stock_id');
            if (pk) pk.readOnly = true;
        }


        // ── 4) 초기 로드 ──────────────────────────────────────────────────────────
        loadStock(stockId);
    })();
</script>
</body>
</html>
