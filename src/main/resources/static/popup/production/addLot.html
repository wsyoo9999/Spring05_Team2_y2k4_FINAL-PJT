<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì‚° ì‹¤ì (Lot) ë“±ë¡</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4A90E2; --bg-light: #F8F9FA; --text-dark: #333333; --border-color: #E0E0E0; --card-bg: #FFFFFF; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-light); color: var(--text-dark); padding: 20px; margin: 0; }
        .form-card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px 30px; }
        h2 { font-size: 22px; font-weight: 700; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; font-size: 14px; }
        .form-group input[type="date"], .form-group input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 15px; color: var(--text-dark); box-sizing: border-box; }
        .form-group input:focus { border-color: var(--primary-color); outline: none; }
        .submit-button { background-color: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 500; width: 100%; margin-top: 10px; }
        .submit-button:hover { background-color: #3A7BD5; }
    </style>
</head>
<body>
<div class="form-card">
    <h2><i class="fas fa-plus-circle"></i> ìƒì‚° ì‹¤ì  ë“±ë¡</h2>
    <form method="POST" action="/api/production/lot/add" id="form">
        <input type="hidden" id="work_order_id" name="work_order_id">
        <input type="hidden" id="stock_id" name="stock_id">

        <div class="form-group">
            <label for="lot_date">ìƒì‚°ì¼ (Lot Date)</label>
            <input type="date" id="lot_date" name="lot_date" required>
        </div>
        <div class="form-group">
            <label for="lot_qty">ìƒì‚° ìˆ˜ëŸ‰ (Lot Qty)</label>
            <input type="number" id="lot_qty" name="lot_qty" min="1" required>
        </div>
        <br>
        <button type="submit" class="submit-button">
            <i class="fas fa-check"></i> ì‹¤ì  ë“±ë¡
        </button>
    </form>
</div>
<script>

    let maxQty = 0;
    let minDate = '';

    // 1. URLì—ì„œ íŒŒë¼ë¯¸í„° ì½ì–´ì„œ ìœ íš¨ì„± ê²€ì‚¬ ê·œì¹™ ì„¤ì •
    $(document).ready(function() {
        const params = new URLSearchParams(window.location.search);

        // 1-1. ìˆ¨ê²¨ì§„ í•„ë“œ ê°’ ì„¤ì •
        const workOrderId = params.get('work_order_id');
        const stockId = params.get('stock_id');
        if (workOrderId) $('#work_order_id').val(workOrderId);
        if (stockId) $('#stock_id').val(stockId);

        // 1-2. ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬ (Rule 1)
        minDate = params.get('start_date');
        const lotDateInput = $('#lot_date');
        if (minDate) {
            lotDateInput.attr('min', minDate);
            // ì˜¤ëŠ˜ ë‚ ì§œê°€ minDateë³´ë‹¤ ë¹ ë¥´ë©´ minDateë¥¼, ì•„ë‹ˆë©´ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ
            const today = new Date().toISOString().split('T')[0];
            lotDateInput.val(today > minDate ? today : minDate);
        } else {
            // start_dateê°€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ
            lotDateInput.val(new Date().toISOString().split('T')[0]);
        }

        // 1-3. ìˆ˜ëŸ‰ ìœ íš¨ì„± ê²€ì‚¬ (Rule 2)
        const targetQty = parseInt(params.get('target_qty') || '0');
        const currentGoodQty = parseInt(params.get('current_good_qty') || '0');
        maxQty = targetQty - currentGoodQty; // ğŸ‘ˆ ì „ì—­ ë³€ìˆ˜ì— ìµœëŒ€ ìˆ˜ëŸ‰ ì €ì¥

        const lotQtyInput = $('#lot_qty');
        if (maxQty <= 0) {
            // ì´ë¯¸ ëª©í‘œìˆ˜ëŸ‰ì„ ì´ˆê³¼í–ˆê±°ë‚˜ ë‹¬ì„±í•œ ê²½ìš°
            lotQtyInput.attr('max', 0);
            lotQtyInput.val(0);
            lotQtyInput.attr('placeholder', 'ì´ë¯¸ ëª©í‘œìˆ˜ëŸ‰ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.');
            lotQtyInput.prop('disabled', true); // ì…ë ¥ ë¹„í™œì„±í™”
        } else {
            lotQtyInput.attr('max', maxQty);
            lotQtyInput.attr('placeholder', `ìµœëŒ€ ${maxQty}ê°œ ì…ë ¥ ê°€ëŠ¥`);
        }
    });

    // 2. í¼ ì œì¶œ ì‹œ ìµœì¢… ìœ íš¨ì„± ê²€ì‚¬
    const form = document.getElementById("form");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // ğŸ”½ [ì¶”ê°€] JavaScriptì—ì„œ í•œ ë²ˆ ë” ê²€ì¦
        const enteredQty = parseInt($('#lot_qty').val());
        const enteredDate = $('#lot_date').val();

        if (maxQty <= 0) {
            alert('ì´ë¯¸ ëª©í‘œìˆ˜ëŸ‰ì„ ëª¨ë‘ ë“±ë¡í–ˆìœ¼ë¯€ë¡œ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if (enteredQty > maxQty) {
            alert(`ìµœëŒ€ ìƒì‚° ê°€ëŠ¥ ìˆ˜ëŸ‰(${maxQty}ê°œ)ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.`);
            return;
        }
        if (minDate && enteredDate < minDate) {
            alert(`ìƒì‚°ì¼ì€ ì‘ì—…ì§€ì‹œì„œ ì‹œì‘ì¼(${minDate}) ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        // ğŸ”¼ [ì¶”ê°€] ê²€ì¦ ì™„ë£Œ

        try {
            const result = await $.ajax({
                url: form.action,
                method: 'POST',
                dataType: 'json',
                data: $(form).serialize()
            });
            if (result === true) {
                alert('âœ… ìƒì‚° ì‹¤ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                if (window.opener && !window.opener.closed) {
                    // ë¶€ëª¨ íŒì—…(detailWorkOrder)ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
                    window.opener.location.reload();
                }
                window.close();
            } else {
                alert('âŒ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
            alert('âŒ ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
</script>
</body>
</html>