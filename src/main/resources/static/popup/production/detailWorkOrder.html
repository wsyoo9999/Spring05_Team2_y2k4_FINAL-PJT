<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>작업지시서 상세</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50B86C;
            --danger-color: #E95353;
            --bg-light: #F8F9FA;
            --text-dark: #333333;
            --border-color: #E0E0E0;
            --card-bg: #FFFFFF;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            padding: 20px;
            margin: 0;
        }
        .detail-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px 30px;
        }
        h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h3 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            color: #444;
        }
        .status-badge {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
        }
        .status-waiting { background-color: #6c757d; }
        .status-progress { background-color: var(--primary-color); }
        .status-complete { background-color: var(--secondary-color); }

        /* 정보 표시용 그리드 */
        .info-grid {
            display: grid;
            grid-template-columns: 180px 1fr; /* 라벨 너비 고정 */
            gap: 10px 15px; /* 가로 세로 간격 */
            margin-bottom: 15px;
            align-items: center; /* 수직 중앙 정렬 */
        }
        .info-grid .label {
            font-weight: 500;
            color: #555;
            background-color: var(--bg-light);
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid transparent; /* 높이 맞춤용 */
        }
        .info-grid .value {
            padding: 10px 12px;
            font-weight: 500;
            color: #333;
            border-bottom: 1px solid var(--border-color);
        }
        .info-grid .value.good { color: var(--secondary-color); font-weight: 700; }
        .info-grid .value.defect { color: var(--danger-color); font-weight: 700; }

        /* 버튼 영역 */
        .action-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end; /* 버튼 우측 정렬 */
        }
        .action-button {
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-delete {
            background: none;
            border: none;
            color: #888;       /* 기본 회색 */
            cursor: pointer;
            font-size: 16px;   /* 아이콘 크기 */
            padding: 4px 8px;
            transition: color 0.2s;
        }
        .action-button:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #3A7BD5; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #d94343; }

        /* --- [추가] Lot 등록 폼 스타일 --- */
        #add-lot-form-container {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px dashed var(--border-color); /* 구분선 */
            animation: slideDown 0.3s ease-out;
        }

        /* 폼 입력 필드 (기존 .value와 어울리게)1 */
        .form-input {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            color: var(--text-dark);
            box-sizing: border-box;
            transition: border-color 0.2s;
            background-color: #fff;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .table-responsive {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.95em;
        }
        .data-table th {
            background-color: #f1f3f5;
            color: #495057;
            font-weight: 600;
            padding: 10px;
            border-bottom: 2px solid #dce4ec;
            text-align: center;
        }
        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: #333;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="detail-card">
    <div id="detail-header"></div>
    <div id="detail-container">
        <p style="text-align: center; padding: 20px;">상세 정보를 불러오는 중입니다...</p>
    </div>

    <div id="action-container" class="action-container"></div>

    <div id="add-lot-form-container" style="display: none;">
        <h3><i class="fas fa-boxes"></i> 신규 생산 실적 등록</h3>

        <form method="POST" action="/api/production/lot/add" id="addLotForm">
            <input type="hidden" id="lot_work_order_id" name="work_order_id">
            <input type="hidden" id="lot_stock_id" name="stock_id">

            <div class="info-grid">
                <div class="label">생산일자 (Lot Date)</div>
                <div>
                    <input class="form-input" type="date" id="lot_date" name="lot_date" required>
                </div>

                <div class="label">생산수량 (Lot Qty)</div>
                <div>
                    <input class="form-input" type="number" id="lot_qty" name="lot_qty" min="1" placeholder="수량을 입력하세요" required>
                </div>
            </div>

            <div class="action-container" style="border-top: none; padding-top: 10px;">
                <button type="submit" class="action-button btn-primary">
                    <i class="fas fa-check"></i> 등록 완료
                </button>
                <button type="button" id="cancel-lot-add" class="action-button btn-secondary">
                    <i class="fas fa-times"></i> 취소
                </button>
            </div>
        </form>
    </div>
    <div id="add-defect-form-container" class="detail-card card-add-lot" style="display: none; margin-top: 20px; border-top: 2px dashed #E95353;">
        <h3 style="color: #E95353;"><i class="fas fa-exclamation-triangle"></i> 불량 내역 등록</h3>

        <form method="POST" action="/api/production/defect/add" id="addDefectForm">
            <input type="hidden" id="hidden_defect_date" name="defect_date">

            <div class="info-grid">
                <div class="info-item">
                    <label class="label" for="defect_lot_id">대상 Lot No.</label>
                    <select class="form-input" id="defect_lot_id" name="lot_id" required>
                        <option value="">선택</option>
                    </select>
                </div>

                <div class="info-item">
                    <label class="label" for="defect_code">불량 유형</label>
                    <select class="form-input" id="defect_code" name="defect_code" required>
                        <option value="">선택</option>
                        <option value="1">101: 파손/찍힘</option>
                        <option value="2">102: 치수 불량</option>
                        <option value="3">103: 이물질 오염</option>
                        <option value="4">104: 조립 불량</option>
                        <option value="5">105: 기능 고장</option>
                        <option value="99">999: 기타</option>
                    </select>
                </div>

                <div class="info-item">
                    <label class="label" for="defect_qty">불량 수량</label>
                    <input class="form-input" type="number" id="defect_qty" name="defect_qty" min="1" placeholder="수량을 입력하세요" required>
                </div>
            </div>

            <div class="action-container" style="border-top: none; padding-top: 10px;">
                <button type="submit" class="action-button btn-danger">
                    <i class="fas fa-check"></i> 불량 등록
                </button>
                <button type="button" id="cancel-defect-add" class="action-button btn-secondary">
                    <i class="fas fa-times"></i> 취소
                </button>
            </div>
        </form>
    </div>
    <div id="lot-list-container" style="display: none; margin-top: 20px; border-top: 2px dashed #E0E0E0; padding-top: 20px;">
        <h3><i class="fas fa-list-ul"></i> 생산 실적(Lot) 목록</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Lot No.</th>
                    <th>생산일</th>
                    <th>생산수량</th>
                    <th>불량수량</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody id="lot-list-tbody">
                </tbody>
            </table>
        </div>
        <div style="text-align: right; margin-top: 10px;">
            <button type="button" id="close-lot-list" class="action-button btn-secondary">
                <i class="fas fa-times"></i> 닫기
            </button>
        </div>
    </div>
</div>

<script>
    // 날짜 포맷 (YYYY-MM-DD)
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function numberFormat(num) {
        if (num === null || num === undefined) return '0';
        return parseInt(num).toLocaleString('ko-KR');
    }

    function getStatusClass(status) {
        switch(status) {
            case '대기': return 'status-waiting';
            case '진행중': return 'status-progress';
            case '완료': return 'status-complete';
            default: return 'status-waiting';
        }
    }

    // === 메인 로직 ===
    $(document).ready(async function() {
        const headerContainer = $('#detail-header');
        const container = $('#detail-container');
        const actionContainer = $('#action-container');

        const urlParams = new URLSearchParams(window.location.search);
        const work_order_id = urlParams.get('work_order_id');

        let loadedData = null;
        let targetQty = 0;
        let startDate = '';

        try {
            if (!work_order_id) {
                throw new Error('작업 지시서 ID가 없습니다.');
            }

            // 1. 데이터 조회
            const [data, lots] = await Promise.all([
                $.ajax({
                    url: `/api/production/work_order/${work_order_id}`,
                    method: 'GET',
                    dataType: 'json'
                }),
                $.ajax({
                    url: `/api/production/work_order/${work_order_id}/lots`,
                    method: 'GET',
                    dataType: 'json'
                })
            ]);

            loadedData = data;

            const serverGoodQty = data.good_qty || 0;
            const serverDefectQty = data.defect_qty || 0;

            targetQty = loadedData.target_qty || 0;
            startDate = loadedData.start_date ? formatDate(loadedData.start_date) : '';

            const progress = targetQty > 0
                ? Math.round((serverGoodQty / targetQty) * 100)
                : 0;

            // 2. 헤더 HTML 렌더링
            let headerHtml = `
                <h2>
                    <span><i class="fas fa-industry"></i> 작업지시서 상세</span>
                    <span class="status-badge ${getStatusClass(data.order_status)}">${data.order_status ?? '-'}</span>
                </h2>
            `;

            // 3. 상세 정보 HTML 렌더링
            let detailHtml = `
                <h3>기본 정보</h3>
                <div class="info-grid">
                    <div class="label">작업지시번호</div> <div class="value">${data.work_order_id}</div>
                    <div class="label">제품코드</div> <div class="value">${data.stock_id ?? '-'}</div>
                    <div class="label">제품명</div> <div class="value"><strong>${data.stock_name ?? '-'}</strong></div>
                    <div class="label">담당자</div> <div class="value">${data.emp_name ?? (data.emp_id ?? '-')}</div>
                    <div class="label">시작일</div> <div class="value">${formatDate(data.start_date)}</div>
                    <div class="label">완료일</div> <div class="value">${formatDate(data.due_date)}</div>
                    <div class="label">요청일시</div> <div class="value">${formatDateTime(data.request_date)}</div>
                </div>

                <h3>생산 수량</h3>
                <div class="info-grid">
                    <div class="label">목표수량</div>
                    <div class="value">${numberFormat(data.target_qty)}</div>

                    <div class="label">양품수량</div>
                    <div class="value good"><strong>${numberFormat(serverGoodQty)}</strong></div>

                    <div class="label">불량수량</div>
                    <div class="value defect"><strong>${numberFormat(serverDefectQty)}</strong></div>

                    <div class="label">진행률</div>
                    <div class="value"><strong>${progress}%</strong></div>
                </div>
            `;

            // 4. 버튼 HTML 렌더링
            let actionHtml = `
                <button class="action-button btn-primary btn-register-result">
                    <i class="fas fa-plus-circle"></i> 생산 실적 등록
                </button>
                <button class="action-button btn-danger btn-register-defect">
                    <i class="fas fa-exclamation-triangle"></i> 불량 등록
                </button>
                <button class="action-button btn-secondary btn-view-lots">
                    <i class="fas fa-list"></i> Lot 조회
                </button>
            `;

            headerContainer.html(headerHtml);
            container.html(detailHtml);
            actionContainer.html(actionHtml);

            // --- 이벤트 핸들러 ---

            // [1] 생산 실적 등록 버튼 클릭
            actionContainer.on('click', '.btn-register-result', function() {
                if (!loadedData) return;

                // 다른 폼 닫기
                $('#add-defect-form-container').hide();
                $('#lot-list-container').hide();
                $('.btn-register-defect').show();
                $('.btn-view-lots').show();

                const currentGood = loadedData.good_qty || 0;
                const maxQty = targetQty - currentGood;

                if (maxQty <= 0) {
                    alert('이미 목표 수량(양품)을 모두 달성했습니다.');
                    return;
                }

                // 폼 초기화
                $('#lot_work_order_id').val(loadedData.work_order_id);
                $('#lot_stock_id').val(loadedData.stock_id);

                const lotDateInput = $('#lot_date');
                if (startDate) {
                    lotDateInput.attr('min', startDate);
                    const today = new Date().toISOString().split('T')[0];
                    lotDateInput.val(today > startDate ? today : startDate);
                } else {
                    lotDateInput.val(new Date().toISOString().split('T')[0]);
                }

                const lotQtyInput = $('#lot_qty');
                lotQtyInput.attr('max', maxQty);
                lotQtyInput.attr('placeholder', `추가 필요량: ${maxQty}개`);
                lotQtyInput.val('');

                $('#add-lot-form-container').show();
                $(this).hide(); // 버튼 숨김
                document.getElementById('add-lot-form-container').scrollIntoView({ behavior: 'smooth' });
            });

            // [2] 생산 실적 취소 버튼
            $('#cancel-lot-add').on('click', function() {
                $('#add-lot-form-container').hide();
                $('.btn-register-result').show();
            });

            // [3] 생산 실적 폼 제출
            $('#addLotForm').on('submit', async function(e) {
                e.preventDefault();
                const currentGood = loadedData.good_qty || 0;
                const maxQty = targetQty - currentGood;
                const enteredQty = parseInt($('#lot_qty').val());
                const enteredDate = $('#lot_date').val();

                if (maxQty <= 0) {
                    alert('이미 목표 수량을 달성하여 추가할 수 없습니다.');
                    return;
                }
                if (enteredQty > maxQty) {
                    alert(`최대 생산 가능 수량(${maxQty}개)을 초과했습니다.`);
                    return;
                }
                if (startDate && enteredDate < startDate) {
                    alert(`생산일은 작업지시서 시작일(${startDate}) 이전일 수 없습니다.`);
                    return;
                }

                try {
                    const result = await $.ajax({
                        url: $(this).attr('action'),
                        method: 'POST',
                        dataType: 'json',
                        data: $(this).serialize()
                    });

                    if (result === true) {
                        alert('✅ 생산 실적이 등록되었습니다.');
                        window.location.reload();
                    } else {
                        alert('❌ 등록에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('등록 실패:', error);
                    alert('❌ 서버 통신 중 오류가 발생했습니다.');
                }
            });

            // [4] 불량 등록 버튼 클릭
            actionContainer.on('click', '.btn-register-defect', function() {
                // 다른 폼 닫기
                $('#add-lot-form-container').hide();
                $('#lot-list-container').hide();
                $('.btn-register-result').show();
                $('.btn-view-lots').show();

                const lotSelect = $('#defect_lot_id');
                lotSelect.empty();
                lotSelect.append('<option value="">Lot를 선택하세요</option>');

                if (lots && lots.length > 0) {
                    lots.forEach(lot => {
                        const dateStr = formatDate(lot.lot_date);
                        lotSelect.append(`<option value="${lot.lot_id}" data-date="${dateStr}">
                            Lot ${lot.lot_id} (생산: ${dateStr}, 수량: ${numberFormat(lot.lot_qty)})
                        </option>`);
                    });
                } else {
                    alert("등록된 생산 실적(Lot)이 없어 불량을 등록할 수 없습니다.\n먼저 생산 실적을 등록해주세요.");
                    return;
                }

                // 초기화
                $('#defect_code').val('');
                $('#defect_qty').val('');
                $('#hidden_defect_date').val('');

                $('#add-defect-form-container').show();
                $(this).hide(); // 버튼 숨김
                document.getElementById('add-defect-form-container').scrollIntoView({ behavior: 'smooth' });
            });

            // [5] 불량 등록 취소 버튼
            $('#cancel-defect-add').on('click', function() {
                $('#add-defect-form-container').hide();
                $('.btn-register-defect').show();
            });

            // [6] 불량 등록 폼 제출
            $('#addDefectForm').on('submit', async function(e) {
                e.preventDefault();

                const selectedLotId = $('#defect_lot_id').val();
                const defectQty = parseInt($('#defect_qty').val());

                // Lot 날짜 설정
                const selectedOption = $('#defect_lot_id option:selected');
                const lotDate = selectedOption.data('date');
                if (!lotDate) {
                    alert("Lot 정보 오류: 날짜를 찾을 수 없습니다.");
                    return;
                }
                $('#hidden_defect_date').val(lotDate);

                // 유효성 검사
                const selectedLot = lots.find(l => l.lot_id == selectedLotId);
                if (selectedLot && defectQty > selectedLot.lot_qty) {
                    alert(`불량 수량(${defectQty})이 해당 Lot의 생산 수량(${selectedLot.lot_qty})보다 많을 수 없습니다.`);
                    return;
                }

                try {
                    const result = await $.ajax({
                        url: $(this).attr('action'),
                        method: 'POST',
                        dataType: 'json',
                        data: $(this).serialize()
                    });

                    if (result === true) {
                        alert('✅ 불량 내역이 등록되었습니다.');
                        window.location.reload();
                    } else {
                        alert('❌ 등록에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('불량 등록 실패:', error);
                    alert('❌ 서버 통신 중 오류가 발생했습니다.');
                }
            });

            // [7] Lot 조회 버튼 클릭
            actionContainer.on('click', '.btn-view-lots', async function() {
                const listContainer = $('#lot-list-container');

                if (listContainer.is(':visible')) {
                    listContainer.hide();
                    $(this).show();
                    return;
                }

                // 다른 폼 닫기
                $('#add-lot-form-container').hide();
                $('#add-defect-form-container').hide();
                $('.btn-register-result').show();
                $('.btn-register-defect').show();

                try {
                    // 데이터 재조회 (최신 상태 반영)
                    const [lotsData, defectsData] = await Promise.all([
                        $.ajax({
                            url: `/api/production/work_order/${loadedData.work_order_id}/lots`,
                            method: 'GET',
                            dataType: 'json'
                        }),
                        $.ajax({
                            url: `/api/production/work_order/${loadedData.work_order_id}/defects`,
                            method: 'GET',
                            dataType: 'json'
                        })
                    ]);

                    // 불량 수량 매핑
                    const defectMap = {};
                    if (defectsData && defectsData.length > 0) {
                        defectsData.forEach(d => {
                            if (!defectMap[d.lot_id]) defectMap[d.lot_id] = 0;
                            defectMap[d.lot_id] += (d.defect_qty || 0);
                        });
                    }

                    let html = '';
                    if (lotsData && lotsData.length > 0) {
                        lotsData.forEach(lot => {
                            const defectQty = defectMap[lot.lot_id] || 0;
                            const defectClass = defectQty > 0 ? 'color: #E95353; font-weight:bold;' : '';

                            // 삭제 버튼이 포함된 행 생성
                            html += `
                <tr>
                    <td><strong>${lot.lot_id}</strong></td>
                    <td>${formatDate(lot.lot_date)}</td>
                    <td>${numberFormat(lot.lot_qty)}</td>
                    <td style="${defectClass}">${numberFormat(defectQty)}</td>
                    <td>
                        <button type="button" class="btn-delete btn-delete-lot"
                                data-lot-id="${lot.lot_id}"
                                title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
                        });
                    } else {
                        html = '<tr><td colspan="4" style="text-align:center; padding: 20px;">등록된 생산 실적이 없습니다.</td></tr>';
                    }

                    $('#lot-list-tbody').html(html);
                    listContainer.show();
                    document.getElementById('lot-list-container').scrollIntoView({ behavior: 'smooth' });

                } catch (err) {
                    console.error('Lot 목록 조회 실패:', err);
                    alert('목록을 불러오는데 실패했습니다.');
                }
            });

            // [8] Lot 목록 닫기
            $('#close-lot-list').on('click', function() {
                $('#lot-list-container').hide();
            });

            $('#lot-list-tbody').on('click', '.btn-delete-lot', async function() {
                const lotId = $(this).data('lot-id');

                if (!confirm(`Lot 번호 [${lotId}] 실적을 삭제하시겠습니까?\n연결된 불량 내역도 함께 삭제됩니다.`)) {
                    return;
                }

                try {
                    const result = await $.ajax({
                        url: `/api/production/lot/${lotId}`,
                        method: 'DELETE',
                        dataType: 'json'
                    });

                    if (result === true) {
                        alert('✅ 삭제되었습니다.');
                        // 목록을 닫았다가 다시 열거나, 새로고침하여 변경된 수량 반영
                        // 여기서는 전체 새로고침을 하여 상단 진행률까지 갱신하는 것이 좋습니다.
                        window.location.reload();
                    } else {
                        alert('❌ 삭제에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('삭제 중 오류:', error);
                    alert('❌ 서버 통신 중 오류가 발생했습니다.');
                }
            });

        } catch (error) {
            console.error('상세 정보 로드 실패:', error);
            container.html(`<p style="color:red; text-align:center; padding:20px;">데이터를 불러오는데 실패했습니다.<br>${error.message}</p>`);
        }
    });
</script>

</body>
</html>