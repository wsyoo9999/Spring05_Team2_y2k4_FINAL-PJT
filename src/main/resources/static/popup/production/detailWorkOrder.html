<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>작업지시서 상세</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #50B86C;
            --danger-color: #E95353;
            --bg-light: #F8F9FA;
            --text-dark: #333333;
            --border-color: #E0E0E0;
            --card-bg: #FFFFFF;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            padding: 20px;
            margin: 0;
        }
        .detail-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 20px 30px;
        }
        h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h3 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
            color: #444;
        }
        .status-badge {
            font-size: 14px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
        }
        .status-waiting { background-color: #6c757d; }
        .status-progress { background-color: var(--primary-color); }
        .status-complete { background-color: var(--secondary-color); }
        .status-discarded { background-color: #343a40; opacity: 0.8; }

        /* 정보 표시용 그리드 */
        .info-grid {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 10px 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .info-grid .label {
            font-weight: 500;
            color: #555;
            background-color: var(--bg-light);
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid transparent;
        }
        .info-grid .value {
            padding: 10px 12px;
            font-weight: 500;
            color: #333;
            border-bottom: 1px solid var(--border-color);
        }
        .info-grid .value.good { color: var(--secondary-color); font-weight: 700; }
        .info-grid .value.defect { color: var(--danger-color); font-weight: 700; }

        /* 버튼 영역 */
        .action-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .action-button {
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-delete {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
            transition: color 0.2s;
        }
        .action-button:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #3A7BD5; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #d94343; }

        /* 폼 스타일 */
        #add-lot-form-container {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px dashed var(--border-color);
            animation: slideDown 0.3s ease-out;
        }
        .form-input {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 15px;
            color: var(--text-dark);
            box-sizing: border-box;
            transition: border-color 0.2s;
            background-color: #fff;
        }
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .table-responsive { overflow-x: auto; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.95em;
        }
        .data-table th {
            background-color: #f1f3f5;
            color: #495057;
            font-weight: 600;
            padding: 7px;
            border-bottom: 2px solid #dce4ec;
            text-align: center;
        }
        .data-table td {
            padding: 7px;
            border-bottom: 1px solid #eee;
            text-align: center;
            color: #333;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background-color: #f8f9fa; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="detail-card">
    <div id="detail-header"></div>
    <div id="detail-container">
        <p style="text-align: center; padding: 20px;">상세 정보를 불러오는 중입니다...</p>
    </div>

    <div id="bom-list-container" style="margin-top: 20px; border-top: 2px dashed #E0E0E0; padding-top: 20px;">
        <h3><i class="fas fa-sitemap"></i> 자재 명세서(BOM) 및 재고 현황</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                <tr>
                    <th>자재코드</th>
                    <th>자재명</th>
                    <th>단위 소요량</th>
                    <th>현재고</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody id="bom-list-tbody">
                <tr><td colspan="5" style="text-align: center;">로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="action-container" class="action-container"></div>

    <div id="add-lot-form-container" style="display: none;">
        <h3><i class="fas fa-boxes"></i> 신규 생산 실적 등록</h3>
        <form method="POST" action="/api/production/lot/add" id="addLotForm">
            <input type="hidden" id="lot_work_order_id" name="work_order_id">
            <input type="hidden" id="lot_stock_id" name="stock_id">

            <div class="info-grid">
                <div class="label">생산일자</div>
                <div>
                    <input class="form-input" type="date" id="lot_date" name="lot_date" required>
                </div>
                <div class="label">총 생산수량</div>
                <div>
                    <input class="form-input" type="number" id="lot_qty" name="lot_qty" min="1" placeholder="양품 + 불량품 총합" required>
                </div>
            </div>

            <div class="info-grid" style="margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px;">
                <div class="label" style="color: #E95353;">불량 유형 (선택)</div>
                <div>
                    <select class="form-input" id="defect_code" name="defect_code">
                        <option value="0">없음 (정상)</option>
                        <option value="1">101: 파손/찍힘</option>
                        <option value="2">102: 치수 불량</option>
                        <option value="3">103: 이물질 오염</option>
                        <option value="4">104: 조립 불량</option>
                        <option value="5">105: 기능 고장</option>
                        <option value="99">999: 기타</option>
                    </select>
                </div>
                <div class="label" style="color: #E95353;">불량 수량 (선택)</div>
                <div>
                    <input class="form-input" type="number" id="defect_qty" name="defect_qty" min="0" value="0" placeholder="0">
                </div>
            </div>

            <div class="action-container" style="border-top: none; padding-top: 10px;">
                <button type="submit" class="action-button btn-primary">
                    <i class="fas fa-check"></i> 등록 완료
                </button>
                <button type="button" id="cancel-lot-add" class="action-button btn-secondary">
                    <i class="fas fa-times"></i> 취소
                </button>
            </div>
        </form>
    </div>

    <div id="lot-list-container" style="display: none; margin-top: 20px; border-top: 2px dashed #E0E0E0; padding-top: 20px;">
        <h3><i class="fas fa-list-ul"></i> 생산 실적(Lot) 목록</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Lot No.</th>
                    <th>생산일</th>
                    <th>생산수량</th>
                    <th>불량수량</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody id="lot-list-tbody"></tbody>
            </table>
        </div>
        <div style="text-align: right; margin-top: 10px;">
            <button type="button" id="close-lot-list" class="action-button btn-secondary">
                <i class="fas fa-times"></i> 닫기
            </button>
        </div>
    </div>
</div>

<script>
    // 날짜 포맷
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function numberFormat(num) {
        if (num === null || num === undefined) return '0';
        return parseInt(num).toLocaleString('ko-KR');
    }

    function getStatusClass(status) {
        switch(status) {
            case '대기': return 'status-waiting';
            case '진행중': return 'status-progress';
            case '완료': return 'status-complete';
            case '폐기': return 'status-discarded';
            default: return 'status-waiting';
        }
    }

    // [추가] BOM 목록 로드 및 렌더링 함수
    async function loadBOM(parentStockId, workOrderData) {
        try {
            const bomList = await $.ajax({
                url: `/api/production/bom/by-parent/${parentStockId}`,
                method: 'GET',
                dataType: 'json'
            });

            let html = '';
            if (bomList && bomList.length > 0) {
                bomList.forEach(bom => {
                    // 남은 필요 수량 계산 (목표 - 현재 양품)
                    const currentGood = workOrderData.good_qty || 0;
                    const remainingTarget = (workOrderData.target_qty || 0) - currentGood;

                    // 남은 생산에 필요한 총 자재량
                    // (이미 완료되었거나 초과 생산 시 remainingTarget이 음수일 수 있으나, 여기선 필요량 계산이므로 max(0) 처리)
                    const neededQty = Math.max(0, remainingTarget);
                    const totalRequired = bom.required_qty * neededQty;

                    // 재고 상태 체크
                    const currentStock = bom.child_stock_qty || 0;
                    // 부족 여부 판단
                    const isShortage = currentStock < totalRequired;
                    const statusStyle = isShortage ? 'color: #E95353; font-weight: bold;' : 'color: #50B86C;';

                    // 상태 텍스트 (남은 필요량 대비)
                    let statusText;
                    if (totalRequired <= 0) {
                        statusText = '완료됨';
                        // 이미 생산 완료되었으면 초록색
                        if(isShortage) statusText = '충분'; // 완료되었으니 재고가 적어도 상관없음 (표시용)
                    } else {
                        statusText = isShortage
                            ? `부족 (-${numberFormat(totalRequired - currentStock)})`
                            : '충분';
                    }

                    html += `
                        <tr>
                            <td>${bom.child_stock_id}</td>
                            <td>${bom.child_stock_name}</td>
                            <td>${numberFormat(bom.required_qty)}</td>
                            <td><strong>${numberFormat(currentStock)}</strong></td>
                            <td style="${statusStyle}">${statusText}</td>
                        </tr>
                    `;
                });
            } else {
                html = '<tr><td colspan="5" style="text-align:center; padding: 20px;">등록된 BOM 정보가 없습니다.</td></tr>';
            }
            $('#bom-list-tbody').html(html);

        } catch (err) {
            console.error('BOM 로드 실패:', err);
            $('#bom-list-tbody').html('<tr><td colspan="5" style="color:red; text-align:center;">BOM 정보를 불러오지 못했습니다.</td></tr>');
        }
    }

    // === 메인 로직 ===
    $(document).ready(async function() {
        const headerContainer = $('#detail-header');
        const container = $('#detail-container');
        const actionContainer = $('#action-container');

        const urlParams = new URLSearchParams(window.location.search);
        const work_order_id = urlParams.get('work_order_id');

        let loadedData = null;
        let targetQty = 0;
        let startDate = '';

        try {
            if (!work_order_id) throw new Error('작업 지시서 ID가 없습니다.');

            const [data] = await Promise.all([
                $.ajax({
                    url: `/api/production/work_order/${work_order_id}`,
                    method: 'GET',
                    dataType: 'json'
                })
            ]);

            loadedData = data;
            const serverGoodQty = data.good_qty || 0;
            const serverDefectQty = data.defect_qty || 0;
            targetQty = loadedData.target_qty || 0;
            startDate = loadedData.start_date ? formatDate(loadedData.start_date) : '';

            const progress = targetQty > 0
                ? Math.round((serverGoodQty / targetQty) * 100)
                : 0;

            // 헤더 및 상세 정보 렌더링
            let headerHtml = `
                <h2>
                    <span><i class="fas fa-industry"></i> 작업지시서 상세</span>
                    <span class="status-badge ${getStatusClass(data.order_status)}">${data.order_status ?? '-'}</span>
                </h2>
            `;

            let detailHtml = `
                <h3>기본 정보</h3>
                <div class="info-grid">
                    <div class="label">작업지시번호</div> <div class="value">${data.work_order_id}</div>
                    <div class="label">제품코드</div> <div class="value">${data.stock_id ?? '-'}</div>
                    <div class="label">제품명</div> <div class="value"><strong>${data.stock_name ?? '-'}</strong></div>
                    <div class="label">담당자</div> <div class="value">${data.emp_name ?? (data.emp_id ?? '-')}</div>
                    <div class="label">시작일</div> <div class="value">${formatDate(data.start_date)}</div>
                    <div class="label">완료일</div> <div class="value">${formatDate(data.due_date)}</div>
                    <div class="label">요청일시</div> <div class="value">${formatDateTime(data.request_date)}</div>
                </div>

                <h3>생산 수량</h3>
                <div class="info-grid">
                    <div class="label">목표수량</div>
                    <div class="value">${numberFormat(data.target_qty)}</div>
                    <div class="label">양품수량</div>
                    <div class="value good"><strong>${numberFormat(serverGoodQty)}</strong></div>
                    <div class="label">불량수량</div>
                    <div class="value defect"><strong>${numberFormat(serverDefectQty)}</strong></div>
                    <div class="label">진행률</div>
                    <div class="value"><strong>${progress}%</strong></div>
                </div>
            `;

            let actionHtml = `
                <button class="action-button btn-primary btn-register-result">
                    <i class="fas fa-plus-circle"></i> 생산 실적 등록
                </button>
                <button class="action-button btn-secondary btn-view-lots">
                    <i class="fas fa-list"></i> Lot 조회
                </button>
            `;

            headerContainer.html(headerHtml);
            container.html(detailHtml);
            actionContainer.html(actionHtml);

            // [추가] BOM 정보 자동 로드 (화면에 바로 표시)
            if (loadedData.stock_id) {
                loadBOM(loadedData.stock_id, loadedData);
            }

            // --- 이벤트 핸들러 ---

            // [1] 생산 실적 등록 버튼 클릭
            actionContainer.on('click', '.btn-register-result', function() {
                if (loadedData.order_status === '완료' || loadedData.order_status === '폐기') {
                    alert(`현재 '${loadedData.order_status}' 상태이므로 생산 실적을 추가할 수 없습니다.`);
                    return;
                }
                $('#lot-list-container').hide();

                // 폼 초기화
                $('#lot_work_order_id').val(loadedData.work_order_id);
                $('#lot_stock_id').val(loadedData.stock_id);

                const lotDateInput = $('#lot_date');
                if (startDate) {
                    lotDateInput.attr('min', startDate);
                    const today = new Date().toISOString().split('T')[0];
                    lotDateInput.val(today > startDate ? today : startDate);
                } else {
                    lotDateInput.val(new Date().toISOString().split('T')[0]);
                }

                $('#lot_qty').attr('placeholder', `생산 수량 입력`);
                $('#lot_qty').val('');

                $('#add-lot-form-container').show();
                $(this).hide();
                document.getElementById('add-lot-form-container').scrollIntoView({ behavior: 'smooth' });
            });

            // [2] 취소 버튼
            $('#cancel-lot-add').on('click', function() {
                $('#add-lot-form-container').hide();
                $('.btn-register-result').show();
            });

            // [3] 생산 실적 폼 제출
            $('#addLotForm').on('submit', async function(e) {
                e.preventDefault();
                const enteredQty = parseInt($('#lot_qty').val());
                const enteredDate = $('#lot_date').val();
                const defectQty = parseInt($('#defect_qty').val()) || 0;

                if (defectQty > enteredQty) {
                    alert(`불량 수량(${defectQty})은 총 생산 수량(${enteredQty})보다 클 수 없습니다.`);
                    return;
                }
                if (startDate && enteredDate < startDate) {
                    alert(`생산일은 작업지시서 시작일(${startDate}) 이전일 수 없습니다.`);
                    return;
                }

                try {
                    const result = await $.ajax({
                        url: $(this).attr('action'),
                        method: 'POST',
                        dataType: 'json',
                        data: $(this).serialize()
                    });

                    if (result === true) {
                        alert('✅ 생산 실적이 등록되었습니다.');
                        window.location.reload();
                    } else {
                        alert('❌ 등록에 실패했습니다.\n(재고 부족 등 원인을 확인하세요)');
                    }
                } catch (error) {
                    console.error('등록 실패:', error);
                    alert('❌ 서버 통신 중 오류가 발생했습니다.');
                }
            });

            // [4] Lot 조회 버튼
            actionContainer.on('click', '.btn-view-lots', async function() {
                const listContainer = $('#lot-list-container');
                if (listContainer.is(':visible')) {
                    listContainer.hide();
                    $(this).show();
                    return;
                }
                $('#add-lot-form-container').hide();
                $('.btn-register-result').show();

                try {
                    const [lotsData, defectsData] = await Promise.all([
                        $.ajax({ url: `/api/production/work_order/${work_order_id}/lots`, method: 'GET', dataType: 'json' }),
                        $.ajax({ url: `/api/production/work_order/${work_order_id}/defects`, method: 'GET', dataType: 'json' })
                    ]);

                    const defectMap = {};
                    if (defectsData) {
                        defectsData.forEach(d => {
                            if (!defectMap[d.lot_id]) defectMap[d.lot_id] = 0;
                            defectMap[d.lot_id] += (d.defect_qty || 0);
                        });
                    }

                    let html = '';
                    if (lotsData && lotsData.length > 0) {
                        lotsData.forEach(lot => {
                            const defectQty = defectMap[lot.lot_id] || 0;
                            const defectClass = defectQty > 0 ? 'color: #E95353; font-weight:bold;' : '';
                            html += `
                                <tr>
                                    <td><strong>${lot.lot_id}</strong></td>
                                    <td>${formatDate(lot.lot_date)}</td>
                                    <td>${numberFormat(lot.lot_qty)}</td>
                                    <td style="${defectClass}">${numberFormat(defectQty)}</td>
                                    <td>
                                        <button type="button" class="btn-delete btn-delete-lot" data-lot-id="${lot.lot_id}" title="삭제">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                        });
                    } else {
                        html = '<tr><td colspan="5" style="text-align:center; padding: 20px;">등록된 생산 실적이 없습니다.</td></tr>';
                    }
                    $('#lot-list-tbody').html(html);
                    listContainer.show();
                    document.getElementById('lot-list-container').scrollIntoView({ behavior: 'smooth' });

                } catch (err) {
                    console.error('Lot 목록 조회 실패:', err);
                    alert('목록을 불러오는데 실패했습니다.');
                }
            });

            // [5] Lot 목록 닫기
            $('#close-lot-list').on('click', function() {
                $('#lot-list-container').hide();
            });

            // [6] Lot 삭제
            $('#lot-list-tbody').on('click', '.btn-delete-lot', async function() {
                const lotId = $(this).data('lot-id');
                if (!confirm(`Lot 번호 [${lotId}] 실적을 삭제하시겠습니까?\n연결된 불량 내역도 함께 삭제됩니다.`)) return;

                try {
                    const result = await $.ajax({
                        url: `/api/production/lot/${lotId}`,
                        method: 'DELETE',
                        dataType: 'json'
                    });
                    if (result === true) {
                        alert('✅ 삭제되었습니다.');
                        window.location.reload();
                    } else {
                        alert('❌ 삭제에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('삭제 중 오류:', error);
                    alert('❌ 서버 통신 중 오류가 발생했습니다.');
                }
            });

        } catch (error) {
            console.error('상세 정보 로드 실패:', error);
            container.html(`<p style="color:red; text-align:center; padding:20px;">데이터를 불러오는데 실패했습니다.<br>${error.message}</p>`);
        }
    });
</script>

</body>
</html>